<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>API Recherche d’Entreprises</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Lien vers le CSS de Select2 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <!-- Lien vers le JavaScript de Select2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

</head>
<body>
    <div class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark">
        <div class="container-fluid">
          <a href="../" class="navbar-brand">KoopaNy</a>
        </div>
      </div>
    <div class="container-fluid mt-4">
        <h1>Recherche d'Entreprises</h1>
        <input type="hidden" id="pageNum" value="1">
        <input type="hidden" id="nbPagesTotal" value="0">
        
        
        
        <div class="text-end">
            Results: <span id="nbResults"></span> / <span id="nbResultsTotal"></span>
        </div>
        <div class="text-center">
            <span id="currentPage"></span> / <span id="nbPages"></span><br />
            <a href="#" id="btnFirstPage" onclick="firstPage(); return false;"><< </a> 
            <a href="#" id="btnPreviousPage" onclick="previousPage(); return false;">< Page précédente</a> 
            <a href="#" id="btnNextPage" onclick="nextPage(); return false;">Page suivante ></a> 
            <a href="#" id="btnLastPage" onclick="lastPage(); return false;">>></a> 
        </div>
        <div class="row">
            <div class="col-md-2">
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-2">
                                <input type="text" class="form-control" id="recherche" placeholder="Recherche" value="">
                            </div>
                            <div class="col-md-12 mb-2">
                                <select id="departementSelect" multiple="multiple" class="form-control">
                                    <!-- Les options seront ajoutées ici par le script JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-12 mb-2">
                                <select id="regionSelect" multiple="multiple" class="form-control">
                                    <!-- Les options seront ajoutées ici par le script JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="text" class="form-control" id="activity" placeholder="Code NAF" value="">
                            </div>
                            <div class="col-md-12 mb-2">
                                <select id="numEmployees"  class="form-control">
                                    <option value="">Sélectionnez une tranche d'effectif</option>
                                    <!-- Les options seront ajoutées ici par le script JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="minRevenue" placeholder="CA Min" value="">
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="maxRevenue" placeholder="CA Max" value="">
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="minResultat" placeholder="Résultat Min" value="">
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="maxResultat" placeholder="Résultat Max" value="">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button id="searchButton" class="btn btn-primary btn-sm" onclick="$('#pageNum').val(1); searchCompanies(); return false;">Rechercher</button> 
                            <a href="#" onclick="$('#pageNum').val(1); runPageScan(); return false;" class="btn btn-warning btn-sm">Page Scan</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <table class="table table-sm table-striped table-hover mt-4" style="font-size: 0.8em;">
                    <thead>
                        <tr>
                            <th>Siren</th>
                            <th>NAF</th>
                            <th>Nom Complet</th>
                            <th>Nb salariés</th>
                            <th>Siège</th>
                            <th>CA Année</th>
                            <th>CA</th>
                            <th>Résultat</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable">
                        <!-- Results will be appended here -->
                    </tbody>
                </table>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body">
                        <div class="row mt-4">
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="caCibleMin" placeholder="CA Cible Min" value="">
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="caCibleMax" placeholder="CA Cible Max" value="">
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="resCibleMin" placeholder="Res Cible Min" value="">
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="resCibleMax" placeholder="Res Cible Min" value="">
                            </div>
                            <div class="col-md-12 mb-2">
                                <select id="dptStrict"  class="form-control" placeholder="Strict dpt">
                                    <option>Strict departement</option>
                                    <option value="yes">YES</option>
                                    <option value="no">NO</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-2">
                                <select id="regionStrict"  class="form-control">
                                    <option>Strict region</option>
                                    <option value="yes">YES</option>
                                    <option value="no">NO</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="pageScanFrom" placeholder="Scan from" value="1">
                            </div>
                            <div class="col-md-12 mb-2">
                                <input type="number" class="form-control" id="pageScanTo" placeholder="Scan to" value="10">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        const regions = [
            {"code": "01", "description": "Guadeloupe"},
            {"code": "02", "description": "Martinique"},
            {"code": "03", "description": "Guyane"},
            {"code": "04", "description": "La Réunion"},
            {"code": "06", "description": "Mayotte"},
            {"code": "11", "description": "Île-de-France"},
            {"code": "24", "description": "Centre-Val de Loire"},
            {"code": "27", "description": "Bourgogne-Franche-Comté"},
            {"code": "28", "description": "Normandie"},
            {"code": "32", "description": "Hauts-de-France"},
            {"code": "44", "description": "Grand Est"},
            {"code": "52", "description": "Pays de la Loire"},
            {"code": "53", "description": "Bretagne"},
            {"code": "75", "description": "Nouvelle-Aquitaine"},
            {"code": "76", "description": "Occitanie"},
            {"code": "84", "description": "Auvergne-Rhône-Alpes"},
            {"code": "93", "description": "Provence-Alpes-Côte d'Azur"},
            {"code": "94", "description": "Corse"}
        ];

        const tranchesEffectifs = [
            {"code": "NN", "description": "Unité non employeuse (pas de salarié au cours de l'année de référence et pas d'effectif au 31/12)"},
            {"code": "00", "description": "0 salarié (n'ayant pas d'effectif au 31/12 mais ayant employé des salariés au cours de l'année de référence)"},
            {"code": "01", "description": "1 ou 2 salariés"},
            {"code": "02", "description": "3 à 5 salariés"},
            {"code": "03", "description": "6 à 9 salariés"},
            {"code": "11", "description": "10 à 19 salariés"},
            {"code": "12", "description": "20 à 49 salariés"},
            {"code": "21", "description": "50 à 99 salariés"},
            {"code": "22", "description": "100 à 199 salariés"},
            {"code": "31", "description": "200 à 249 salariés"},
            {"code": "32", "description": "250 à 499 salariés"},
            {"code": "41", "description": "500 à 999 salariés"},
            {"code": "42", "description": "1 000 à 1 999 salariés"},
            {"code": "51", "description": "2 000 à 4 999 salariés"},
            {"code": "52", "description": "5 000 à 9 999 salariés"},
            {"code": "53", "description": "10 000 salariés et plus"}
        ];

        const departements = [
            {"code": "01", "description": "Ain"},
            {"code": "02", "description": "Aisne"},
            {"code": "03", "description": "Allier"},
            {"code": "04", "description": "Alpes-de-Haute-Provence"},
            {"code": "05", "description": "Hautes-Alpes"},
            {"code": "06", "description": "Alpes-Maritimes"},
            {"code": "07", "description": "Ardèche"},
            {"code": "08", "description": "Ardennes"},
            {"code": "09", "description": "Ariège"},
            {"code": "10", "description": "Aube"},
            {"code": "11", "description": "Aude"},
            {"code": "12", "description": "Aveyron"},
            {"code": "13", "description": "Bouches-du-Rhône"},
            {"code": "14", "description": "Calvados"},
            {"code": "15", "description": "Cantal"},
            {"code": "16", "description": "Charente"},
            {"code": "17", "description": "Charente-Maritime"},
            {"code": "18", "description": "Cher"},
            {"code": "19", "description": "Corrèze"},
            {"code": "21", "description": "Côte-d'Or"},
            {"code": "22", "description": "Côtes-d'Armor"},
            {"code": "23", "description": "Creuse"},
            {"code": "24", "description": "Dordogne"},
            {"code": "25", "description": "Doubs"},
            {"code": "26", "description": "Drôme"},
            {"code": "27", "description": "Eure"},
            {"code": "28", "description": "Eure-et-Loir"},
            {"code": "29", "description": "Finistère"},
            {"code": "2A", "description": "Corse-du-Sud"},
            {"code": "2B", "description": "Haute-Corse"},
            {"code": "30", "description": "Gard"},
            {"code": "31", "description": "Haute-Garonne"},
            {"code": "32", "description": "Gers"},
            {"code": "33", "description": "Gironde"},
            {"code": "34", "description": "Hérault"},
            {"code": "35", "description": "Ille-et-Vilaine"},
            {"code": "36", "description": "Indre"},
            {"code": "37", "description": "Indre-et-Loire"},
            {"code": "38", "description": "Isère"},
            {"code": "39", "description": "Jura"},
            {"code": "40", "description": "Landes"},
            {"code": "41", "description": "Loir-et-Cher"},
            {"code": "42", "description": "Loire"},
            {"code": "43", "description": "Haute-Loire"},
            {"code": "44", "description": "Loire-Atlantique"},
            {"code": "45", "description": "Loiret"},
            {"code": "46", "description": "Lot"},
            {"code": "47", "description": "Lot-et-Garonne"},
            {"code": "48", "description": "Lozère"},
            {"code": "49", "description": "Maine-et-Loire"},
            {"code": "50", "description": "Manche"},
            {"code": "51", "description": "Marne"},
            {"code": "52", "description": "Haute-Marne"},
            {"code": "53", "description": "Mayenne"},
            {"code": "54", "description": "Meurthe-et-Moselle"},
            {"code": "55", "description": "Meuse"},
            {"code": "56", "description": "Morbihan"},
            {"code": "57", "description": "Moselle"},
            {"code": "58", "description": "Nièvre"},
            {"code": "59", "description": "Nord"},
            {"code": "60", "description": "Oise"},
            {"code": "61", "description": "Orne"},
            {"code": "62", "description": "Pas-de-Calais"},
            {"code": "63", "description": "Puy-de-Dôme"},
            {"code": "64", "description": "Pyrénées-Atlantiques"},
            {"code": "65", "description": "Hautes-Pyrénées"},
            {"code": "66", "description": "Pyrénées-Orientales"},
            {"code": "67", "description": "Bas-Rhin"},
            {"code": "68", "description": "Haut-Rhin"},
            {"code": "69", "description": "Rhône"},
            {"code": "70", "description": "Haute-Saône"},
            {"code": "71", "description": "Saône-et-Loire"},
            {"code": "72", "description": "Sarthe"},
            {"code": "73", "description": "Savoie"},
            {"code": "74", "description": "Haute-Savoie"},
            {"code": "75", "description": "Paris"},
            {"code": "76", "description": "Seine-Maritime"},
            {"code": "77", "description": "Seine-et-Marne"},
            {"code": "78", "description": "Yvelines"},
            {"code": "79", "description": "Deux-Sèvres"},
            {"code": "80", "description": "Somme"},
            {"code": "81", "description": "Tarn"},
            {"code": "82", "description": "Tarn-et-Garonne"},
            {"code": "83", "description": "Var"},
            {"code": "84", "description": "Vaucluse"},
            {"code": "85", "description": "Vendée"},
            {"code": "86", "description": "Vienne"},
            {"code": "87", "description": "Haute-Vienne"},
            {"code": "88", "description": "Vosges"},
            {"code": "89", "description": "Yonne"},
            {"code": "90", "description": "Territoire de Belfort"},
            {"code": "91", "description": "Essonne"},
            {"code": "92", "description": "Hauts-de-Seine"},
            {"code": "93", "description": "Seine-Saint-Denis"},
            {"code": "94", "description": "Val-de-Marne"},
            {"code": "95", "description": "Val-d'Oise"},
            {"code": "971", "description": "Guadeloupe"},
            {"code": "972", "description": "Martinique"},
            {"code": "973", "description": "Guyane"},
            {"code": "974", "description": "La Réunion"},
            {"code": "976", "description": "Mayotte"}
        ];


        function getEmployeeRangeDescription(code) {
            const range = tranchesEffectifs.find(range => range.code === code);
            return range ? range.description : 'Tranche non trouvée';
        }

        function firstPage()
        {
            $('#pageNum').val(1); 
            searchCompanies();
        }
        function lastPage()
        {
            $('#pageNum').val($('#nbPagesTotal').val()); 
            searchCompanies();
        }
        function nextPage()
        {
            $('#pageNum').val(eval($('#pageNum').val())+1); 
            searchCompanies();
        }
        function previousPage()
        {
            $('#pageNum').val(eval($('#pageNum').val())-1); 
            searchCompanies();
        }
        
        function runPageScan()
        {
            pageScanFrom=eval($('#pageScanFrom').val());
            currentPage=eval($('#pageNum').val());
            pageScanTo=eval($('#pageScanTo').val());
            currentPage=eval($('#pageNum').val());
            if (currentPage == pageScanFrom)
            {
                $('#resultsTable').empty();
            }
            searchCompanies(false);
            setTimeout(function() {
                
                if (currentPage < pageScanTo) {
                    $('#pageNum').val(eval($('#pageNum').val())+1);
                    runPageScan();
                }
            }, 1000);
        }

        function buildAjaxData(params) {
            let data = {
                q: params.recherche,
                page: currentPage,
                per_page: 25
            };

            // Ajouter dynamiquement des champs s'ils ne sont pas vides
            
            if (params.activity) {
                data.activite_principale = params.activity;
            }
            if (params.caMin) {
                data.ca_min = params.caMin;
            }
            if (params.caMax) {
                data.ca_max = params.caMax;
            }
            if (params.resMin) {
                data.resultat_net_min = params.resMin;
            }
            if (params.resMax) {
                data.resultat_net_max = params.resMax;
            }
            if (params.numEmployees) {
                data.tranche_effectif_salarie = params.numEmployees;
            }
            if (params.regions) {
                data.region = params.regions;
            }
            if (params.departements) {
                data.departement = params.departements;
            }

            return data;
        }

        $('#recherche').keypress(function(event) {
            if (event.which == 13) {  // 13 est le code clé pour la touche Entrée
                event.preventDefault();  // Empêche tout comportement par défaut (comme soumettre un formulaire)
                searchCompanies();  // Appelle la fonction que vous souhaitez exécuter
            }
        });


        function searchCompanies(emptyTable=true)
        {
            var selectedValuesRegions = $('#regionSelect').val();
            var regionSelect = selectedValuesRegions.join(',');

            var selectedValuesDepartements = $('#departementSelect').val();
            var departementSelect = selectedValuesDepartements.join(',');

            var params = {
                    departement: $('#departement').val(),
                    numEmployees: $('#numEmployees').val(),
                    activity: $('#activity').val(),
                    caMin: $('#minRevenue').val(),
                    caMax: $('#maxRevenue').val(),
                    resMin: $('#minResultat').val(),
                    resMax: $('#maxResultat').val(),
                    recherche: $('#recherche').val(),
                    regions: regionSelect,
                    departements: departementSelect,
                    etat_administratif: "A"
                };
            currentPage=eval($('#pageNum').val());
            $.ajax({
                url: 'https://recherche-entreprises.api.gouv.fr/search',
                data: buildAjaxData(params),
                success: function(data) {
                    $('#currentPage').html($('#pageNum').val());
                    $('#nbResults').html(data.results.length+' résultats');
                    if (emptyTable) { $('#resultsTable').empty(); }
                    $('#nbResultsTotal').html(data.total_results);
                    $('#nbPages').html(data.total_pages);
                    $('#nbPagesTotal').val(data.total_pages);

                    
                    if (currentPage == 1) {
                        $('#btnPreviousPage').hide();
                        $('#btnFirstPage').hide();
                    } else {
                        $('#btnPreviousPage').show();
                        $('#btnFirstPage').show();
                    }
                    if (currentPage < data.total_pages)
                    {
                        $('#btnNextPage').show();
                        $('#btnLastPage').show();
                    } else {
                        $('#btnNextPage').hide();
                        $('#btnLastPage').hide();
                    }
                    data.results.forEach(function(item) {
                        infosBureaux_commune='';
                        infosBureaux_adresse='';
                        siege='oui';
                        dptStrict=$('#dptStrict').val();
                        regionStrict=$('#regionStrict').val();
                        

                        // if (item.matching_etablissements.length > 0)
                        // {
                        //     item.matching_etablissements.forEach(function(etablissement) {
                        //     console.log(etablissement.date_fermeture);
                        //     if (etablissement.date_fermeture != 'null') {
                        //         infosBureaux_commune=etablissement.libelle_commune;
                        //         infosBureaux_adresse=etablissement.adresse;
                        //         infosBureaux_departement
                        //         siege='non';
                        //     }
                        //     });
                        // } else {
                        //     infosBureaux_commune=item.siege.libelle_commune;
                        //     infosBureaux_adresse=item.siege.adresse;
                        //     infosBureaux_departement=item.siege.department;
                        // }
                        
                        infosBureaux_commune=item.siege.libelle_commune;
                        infosBureaux_adresse=item.siege.adresse;
                        infosBureaux_departement=item.siege.departement;
                        infoBureaux_region=item.siege.region;
                        addData=true;
                        var selectedDepartments = $('#departementSelect').val();
                        var selectedRegions = $('#regionSelect').val();
                        if ((dptStrict == 'yes') && (! selectedDepartments.includes(String(infosBureaux_departement))))
                        {
                            addData=false;
                        }

                        if ((regionStrict == 'yes') && (! selectedRegions.includes(String(infoBureaux_region))))
                        {
                            addData=false;
                        }

                        if (addData == true)
                        {
                            finances='';
                            let nombreAnneesFinances = Object.keys(item.finances).length;
                            caAnnee='';
                            caMontant='';
                            caResultat='';
                            caColor='success';
                            resColor='success';
                            if (nombreAnneesFinances > 0)
                            {
                                finances = '';
                                let first = true; // Flag pour vérifier si c'est la première itération
                                
                                caCibleMin = $('#caCibleMin').val();
                                resCibleMin = $('#resCibleMin').val();
                                for (let annee in item.finances) {
                                    if (first) { // Vérifie si c'est la première itération
                                        let finance = item.finances[annee];
                                        
                                        caColor = (finance.ca < caCibleMin) ? 'danger' : 'success';
                                        resColor = (finance.resultat_net <= resCibleMin) ? 'danger' : 'success';
                                        caAnnee=annee;
                                        caMontant=finance.ca.toLocaleString('fr-FR');
                                        caResultat=finance.resultat_net.toLocaleString('fr-FR');
                                        first = false; // Mettre le flag à false après la première itération
                                        break; // Arrête la boucle après la première itération
                                    }
                                }
                            }
                            nbSalaries=getEmployeeRangeDescription(item.tranche_effectif_salarie)
                            $('#resultsTable').append(
                                `<tr>
                                    <td>${item.siren}</td>
                                    <td>${item.activite_principale}</td>
                                    <td>${item.nom_complet}</td>
                                    <td>${nbSalaries}</td>
                                    <td>${infosBureaux_commune}</td>
                                    <td>${caAnnee}</td>
                                    <td><span class="badge bg-${caColor}">${caMontant} €</span></td>
                                    <td><span class="badge bg-${resColor}">${caResultat} €</span></td>
                                </tr>`
                            );
                        }
                        
                    });
                },
                error: function() {
                    alert('Error fetching data.');
                }
            });
        }
        $(document).ready(function() {

            const $select = $('#numEmployees');
            $.each(tranchesEffectifs, function(index, tranche) {
                $select.append($('<option>', {
                    value: tranche.code,
                    text: tranche.description
                }));
            });

            const selectElement = document.getElementById('regionSelect');
                regions.forEach(function(region) {
                    const option = document.createElement('option');
                    option.value = region.code;
                    option.textContent = region.description;
                    selectElement.appendChild(option);
                });

            // Initialiser Select2
            $('#regionSelect').select2({
                placeholder: "Sélectionnez des régions",
                allowClear: true
            });

            const selecDepartement = document.getElementById('departementSelect');
                departements.forEach(function(departement) {
                    const option = document.createElement('option');
                    option.value = departement.code;
                    option.textContent = departement.description;
                    selecDepartement.appendChild(option);
                });

            // Initialiser Select2
            $('#departementSelect').select2({
                placeholder: "Sélectionnez des départements",
                allowClear: true
            });
        });
    </script>
</body>
</html>
